name: Generate Native Plot Data (Ryan White State-Level)

# ===========================================
# NOTES
# ===========================================
# - Uses same container as MSA-level (ghcr.io/ncsizemore/jheem-ryan-white-model)
# - Simulations mounted to simulations/ryan-white/ to match container's expected path
# - Container --city flag works with state codes (AL, CA, etc.)
# - Aggregation script (aggregate-city-data.ts) works for both city and state codes
# - Summary script uses state-specific version (generate-state-summaries.ts)
# ===========================================

on:
  workflow_dispatch:
    inputs:
      states:
        description: 'States to generate'
        required: true
        default: 'test'
        type: choice
        options:
          - test      # 3 states for testing
          - full      # All 11 states
      simulation_release:
        description: 'Simulation release tag from jheem-simulations'
        required: true
        default: 'ryan-white-state-v1.0.0'
        type: string
      container_image:
        description: 'Container image to use (same container works for MSA and state-level)'
        required: true
        default: 'ghcr.io/ncsizemore/jheem-ryan-white-model:latest'
        type: string
      include_individual_simulation:
        description: 'Include individual simulation statistic (larger files)'
        required: true
        default: false
        type: boolean
      dry_run:
        description: 'Skip S3 uploads (for testing generation and aggregation only)'
        required: true
        default: true
        type: boolean
      max_parallel:
        description: 'Maximum parallel state jobs'
        required: true
        default: '5'
        type: string

env:
  # Statistics to generate (individual.simulation excluded by default)
  BASE_STATISTICS: 'mean.and.interval,median.and.interval'
  ALL_STATISTICS: 'mean.and.interval,median.and.interval,individual.simulation'

  # All facets including multi-dimensional
  FACETS: 'none,age,race,sex,risk,age+race,age+sex,age+risk,race+sex,race+risk,sex+risk,age+race+sex,age+race+risk,age+sex+risk,race+sex+risk,age+race+sex+risk'

  # All outcomes
  OUTCOMES: 'incidence,diagnosed.prevalence,suppression,testing,prep.uptake,awareness,rw.clients,adap.clients,non.adap.clients,oahs.clients,adap.proportion,oahs.suppression,adap.suppression,new'

  # All scenarios
  SCENARIOS: 'cessation,brief_interruption,prolonged_interruption'

jobs:
  # ===========================================
  # Phase 1: Prepare state list
  # ===========================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      states: ${{ steps.set-states.outputs.states }}
      statistics: ${{ steps.set-stats.outputs.statistics }}
    steps:
      - name: Set state list
        id: set-states
        run: |
          if [ "${{ github.event.inputs.states }}" == "test" ]; then
            # Test set: AL + CA + FL
            echo 'states=["AL", "CA", "FL"]' >> $GITHUB_OUTPUT
            echo "Using TEST state set (3 states)"
          else
            # Full set: All 11 states
            echo 'states=["AL", "CA", "FL", "GA", "IL", "LA", "MO", "MS", "NY", "TX", "WI"]' >> $GITHUB_OUTPUT
            echo "Using FULL state set (11 states)"
          fi

      - name: Set statistics
        id: set-stats
        run: |
          if [ "${{ github.event.inputs.include_individual_simulation }}" == "true" ]; then
            echo "statistics=${{ env.ALL_STATISTICS }}" >> $GITHUB_OUTPUT
            echo "Including individual.simulation statistic"
          else
            echo "statistics=${{ env.BASE_STATISTICS }}" >> $GITHUB_OUTPUT
            echo "Excluding individual.simulation statistic"
          fi

  # ===========================================
  # Phase 2: Generate, aggregate, and upload per state
  # ===========================================
  generate:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        state: ${{ fromJson(needs.prepare.outputs.states) }}
      max-parallel: ${{ fromJson(github.event.inputs.max_parallel) }}
      fail-fast: false  # Continue other states if one fails
    steps:
      - name: Checkout jheem-portal (for aggregation scripts)
        uses: actions/checkout@v4
        with:
          repository: ncsizemore/jheem-portal
          path: portal

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install portal dependencies
        working-directory: portal
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download simulation data from GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading simulation data for ${{ matrix.state }} from release ${{ github.event.inputs.simulation_release }}"

          # Mount to simulations/ryan-white/ to match container's expected path
          # (container uses hardcoded path, works for both MSA and state-level)
          mkdir -p simulations/ryan-white/base
          mkdir -p simulations/ryan-white/prerun/${{ matrix.state }}

          # Download all files for this state from the release
          gh release download ${{ github.event.inputs.simulation_release }} \
            --repo ncsizemore/jheem-simulations \
            --pattern "${{ matrix.state }}_*.Rdata" \
            --dir ./tmp-download

          # Move base file
          mv ./tmp-download/${{ matrix.state }}_base.Rdata \
            simulations/ryan-white/base/${{ matrix.state }}_base.Rdata

          # Move prerun files (remove state prefix to match expected structure)
          mv ./tmp-download/${{ matrix.state }}_cessation.Rdata \
            simulations/ryan-white/prerun/${{ matrix.state }}/cessation.Rdata
          mv ./tmp-download/${{ matrix.state }}_brief_interruption.Rdata \
            simulations/ryan-white/prerun/${{ matrix.state }}/brief_interruption.Rdata
          mv ./tmp-download/${{ matrix.state }}_prolonged_interruption.Rdata \
            simulations/ryan-white/prerun/${{ matrix.state }}/prolonged_interruption.Rdata

          echo "âœ… Downloaded simulation data"
          ls -la simulations/ryan-white/base/
          ls -la simulations/ryan-white/prerun/${{ matrix.state }}/

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate native data
        run: |
          echo "ğŸ›ï¸ Generating native data for ${{ matrix.state }}"

          mkdir -p output/${{ matrix.state }}

          # Run container with --output-mode data for native JSON output
          # Note: Container exits with code 1 if ANY errors occur, even if most succeed
          # This is expected - some outcome/facet combinations are invalid
          set +e
          docker run --rm \
            -v $(pwd)/simulations:/app/simulations:ro \
            -v $(pwd)/output/${{ matrix.state }}:/output \
            ${{ github.event.inputs.container_image }} \
            batch \
            --city ${{ matrix.state }} \
            --scenarios ${{ env.SCENARIOS }} \
            --outcomes ${{ env.OUTCOMES }} \
            --statistics ${{ needs.prepare.outputs.statistics }} \
            --facets "${{ env.FACETS }}" \
            --output-dir /output \
            --output-mode data
          exit_code=$?
          set -e

          # Count generated files
          file_count=$(find output/${{ matrix.state }} -name "*.json" 2>/dev/null | wc -l)
          echo "ğŸ“Š Files generated: $file_count"

          # Fail only if NO files were generated (true failure)
          if [ "$file_count" -eq 0 ]; then
            echo "âŒ No files generated - this is a real failure"
            exit 1
          fi

          # Log exit code but don't fail if files were generated
          if [ "$exit_code" -ne 0 ]; then
            echo "âš ï¸ Container exited with code $exit_code (expected - some outcome/facet combos are invalid)"
            echo "âœ… But $file_count files were successfully generated"
          else
            echo "âœ… Generation complete with no errors"
          fi

      - name: Aggregate state data
        working-directory: portal
        run: |
          echo "ğŸ“Š Aggregating data for ${{ matrix.state }}..."

          mkdir -p public/data

          # Find the state data directory
          state_dir="../output/${{ matrix.state }}/${{ matrix.state }}"

          if [ ! -d "$state_dir" ]; then
            # Try without nested directory
            state_dir="../output/${{ matrix.state }}"
          fi

          echo "Using state directory: $state_dir"

          npx tsx scripts/aggregate-city-data.ts "$state_dir" "public/data/${{ matrix.state }}.json"

          if [ -f "public/data/${{ matrix.state }}.json" ]; then
            size=$(ls -lh "public/data/${{ matrix.state }}.json" | awk '{print $5}')
            echo "âœ… Created ${{ matrix.state }}.json ($size)"
          else
            echo "âŒ Failed to create ${{ matrix.state }}.json"
            exit 1
          fi

      - name: Upload to S3
        if: ${{ github.event.inputs.dry_run != 'true' }}
        working-directory: portal
        run: |
          echo "â˜ï¸ Uploading ${{ matrix.state }}.json to S3..."

          # Gzip and upload
          gzip -c "public/data/${{ matrix.state }}.json" > "public/data/${{ matrix.state }}.json.gz"

          aws s3 cp "public/data/${{ matrix.state }}.json.gz" \
            "s3://jheem-data-production/portal/ryan-white-state/${{ matrix.state }}.json" \
            --content-type "application/json" \
            --content-encoding "gzip"

          echo "âœ… Uploaded to S3"

      - name: Skip S3 upload (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        working-directory: portal
        run: |
          echo "ğŸ”¸ DRY RUN - Skipping S3 upload"
          echo "ğŸ“Š Would upload: public/data/${{ matrix.state }}.json"
          ls -lh "public/data/${{ matrix.state }}.json"

  # ===========================================
  # Phase 3: Generate state summaries
  # ===========================================
  finalize:
    needs: [prepare, generate]
    if: ${{ github.event.inputs.dry_run != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout jheem-portal
        uses: actions/checkout@v4
        with:
          repository: ncsizemore/jheem-portal
          path: portal

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: portal
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download aggregated state files from S3
        working-directory: portal
        run: |
          echo "ğŸ“¥ Downloading aggregated state files from S3..."
          mkdir -p public/data

          # Download all state JSON files (2-letter state codes)
          aws s3 sync s3://jheem-data-production/portal/ryan-white-state/ public/data/ \
            --exclude "*" \
            --include "[A-Z][A-Z].json"

          echo "Downloaded files:"
          ls -lh public/data/

      - name: Decompress state files
        working-directory: portal
        run: |
          echo "ğŸ“¦ Decompressing gzipped state files..."

          # Files are stored with Content-Encoding: gzip, so they download as gzipped
          # Decompress each file in place
          for f in public/data/[A-Z][A-Z].json; do
            if [ -f "$f" ] && file "$f" | grep -q "gzip compressed"; then
              echo "  Decompressing $f"
              gunzip -c "$f" > "$f.tmp" && mv "$f.tmp" "$f"
            else
              echo "  $f is already plain JSON or doesn't exist"
            fi
          done

          echo "Decompressed files:"
          ls -lh public/data/

      - name: Generate state summaries
        working-directory: portal
        run: |
          echo "ğŸ“‹ Generating state summaries..."

          npx tsx scripts/generate-state-summaries.ts

          if [ -f "public/data/state-summaries.json" ]; then
            states=$(cat public/data/state-summaries.json | grep -oE '"[A-Z]{2}"' | wc -l)
            echo "âœ… Generated summaries with $states states"
          else
            echo "âŒ Summaries file not created"
            exit 1
          fi

      - name: Upload state summaries to S3
        working-directory: portal
        run: |
          echo "â˜ï¸ Uploading state-summaries.json to S3..."

          gzip -c public/data/state-summaries.json > public/data/state-summaries.json.gz
          aws s3 cp public/data/state-summaries.json.gz \
            "s3://jheem-data-production/portal/ryan-white-state/state-summaries.json" \
            --content-type "application/json" \
            --content-encoding "gzip"

          echo ""
          echo "=========================================="
          echo "ğŸ“Š GENERATION COMPLETE"
          echo "=========================================="
          echo ""
          echo "ğŸ“‹ S3 contents:"
          aws s3 ls s3://jheem-data-production/portal/ryan-white-state/
          echo ""
          echo "ğŸŒ Files available at:"
          echo "   https://d320iym4dtm9lj.cloudfront.net/ryan-white-state/{STATE}.json"
