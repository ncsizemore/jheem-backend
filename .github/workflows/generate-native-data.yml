name: Generate Native Plot Data

on:
  workflow_dispatch:
    inputs:
      cities:
        description: 'Cities to generate'
        required: true
        default: 'test'
        type: choice
        options:
          - test      # 3 cities for testing
          - full      # All 31 cities
      include_individual_simulation:
        description: 'Include individual simulation statistic (larger files)'
        required: true
        default: false
        type: boolean
      max_parallel:
        description: 'Maximum parallel city jobs'
        required: true
        default: '10'
        type: string

env:
  # Statistics to generate (individual.simulation excluded by default)
  BASE_STATISTICS: 'mean.and.interval,median.and.interval'
  ALL_STATISTICS: 'mean.and.interval,median.and.interval,individual.simulation'

  # All facets including multi-dimensional
  FACETS: 'none,age,race,sex,risk,age+race,age+sex,age+risk,race+sex,race+risk,sex+risk,age+race+sex,age+race+risk,age+sex+risk,race+sex+risk,age+race+sex+risk'

  # All outcomes
  OUTCOMES: 'incidence,diagnosed.prevalence,suppression,testing,prep.uptake,awareness,rw.clients,adap.clients,non.adap.clients,oahs.clients,adap.proportion,oahs.suppression,adap.suppression,new'

  # All scenarios
  SCENARIOS: 'cessation,brief_interruption,prolonged_interruption'

jobs:
  # ===========================================
  # Phase 1: Prepare city list
  # ===========================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      cities: ${{ steps.set-cities.outputs.cities }}
      statistics: ${{ steps.set-stats.outputs.statistics }}
    steps:
      - name: Set city list
        id: set-cities
        run: |
          if [ "${{ github.event.inputs.cities }}" == "test" ]; then
            # Test set: Baltimore + Atlanta + Chicago
            echo 'cities=["C.12580", "C.12060", "C.16980"]' >> $GITHUB_OUTPUT
            echo "Using TEST city set (3 cities)"
          else
            # Full set: All 31 cities
            echo 'cities=["C.12060", "C.12420", "C.12580", "C.12940", "C.14460", "C.16740", "C.16980", "C.17460", "C.18140", "C.19100", "C.19820", "C.26420", "C.26900", "C.27260", "C.29820", "C.31080", "C.32820", "C.33100", "C.35380", "C.35620", "C.36740", "C.37980", "C.38060", "C.40140", "C.40900", "C.41700", "C.41740", "C.41860", "C.42660", "C.45300", "C.47900"]' >> $GITHUB_OUTPUT
            echo "Using FULL city set (31 cities)"
          fi

      - name: Set statistics
        id: set-stats
        run: |
          if [ "${{ github.event.inputs.include_individual_simulation }}" == "true" ]; then
            echo "statistics=${{ env.ALL_STATISTICS }}" >> $GITHUB_OUTPUT
            echo "Including individual.simulation statistic"
          else
            echo "statistics=${{ env.BASE_STATISTICS }}" >> $GITHUB_OUTPUT
            echo "Excluding individual.simulation statistic"
          fi

  # ===========================================
  # Phase 2: Generate, aggregate, and upload per city
  # ===========================================
  generate:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        city: ${{ fromJson(needs.prepare.outputs.cities) }}
      max-parallel: ${{ fromJson(github.event.inputs.max_parallel) }}
      fail-fast: false  # Continue other cities if one fails
    steps:
      - name: Checkout jheem-portal (for aggregation scripts)
        uses: actions/checkout@v4
        with:
          repository: ncsizemore/jheem-portal
          path: portal

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install portal dependencies
        working-directory: portal
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download simulation data
        run: |
          echo "ğŸ“¥ Downloading simulation data for ${{ matrix.city }}"

          mkdir -p simulations/ryan-white/base
          mkdir -p simulations/ryan-white/prerun/${{ matrix.city }}

          # Download base simulation
          aws s3 cp s3://jheem-data-production/simulations/ryan-white/base/${{ matrix.city }}_base.Rdata \
            simulations/ryan-white/base/${{ matrix.city }}_base.Rdata

          # Download prerun simulations
          aws s3 sync s3://jheem-data-production/simulations/ryan-white/prerun/${{ matrix.city }}/ \
            simulations/ryan-white/prerun/${{ matrix.city }}/

          echo "âœ… Downloaded simulation data"
          ls -la simulations/ryan-white/base/
          ls -la simulations/ryan-white/prerun/${{ matrix.city }}/

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region us-east-1 | \
            docker login --username AWS --password-stdin 849611540600.dkr.ecr.us-east-1.amazonaws.com

      - name: Generate native data
        run: |
          echo "ğŸ™ï¸ Generating native data for ${{ matrix.city }}"

          mkdir -p output/${{ matrix.city }}

          # Run container with --output-mode data for native JSON output
          # Note: Container exits with code 1 if ANY errors occur, even if most succeed
          # This is expected - some outcome/facet combinations are invalid
          set +e
          docker run --rm \
            -v $(pwd)/simulations:/app/simulations:ro \
            -v $(pwd)/output/${{ matrix.city }}:/output \
            849611540600.dkr.ecr.us-east-1.amazonaws.com/jheem-ryan-white-model:latest \
            batch \
            --city ${{ matrix.city }} \
            --scenarios ${{ env.SCENARIOS }} \
            --outcomes ${{ env.OUTCOMES }} \
            --statistics ${{ needs.prepare.outputs.statistics }} \
            --facets "${{ env.FACETS }}" \
            --output-dir /output \
            --output-mode data
          exit_code=$?
          set -e

          # Count generated files
          file_count=$(find output/${{ matrix.city }} -name "*.json" 2>/dev/null | wc -l)
          echo "ğŸ“Š Files generated: $file_count"

          # Fail only if NO files were generated (true failure)
          if [ "$file_count" -eq 0 ]; then
            echo "âŒ No files generated - this is a real failure"
            exit 1
          fi

          # Log exit code but don't fail if files were generated
          if [ "$exit_code" -ne 0 ]; then
            echo "âš ï¸ Container exited with code $exit_code (expected - some outcome/facet combos are invalid)"
            echo "âœ… But $file_count files were successfully generated"
          else
            echo "âœ… Generation complete with no errors"
          fi

      - name: Aggregate city data
        working-directory: portal
        run: |
          echo "ğŸ“Š Aggregating data for ${{ matrix.city }}..."

          mkdir -p public/data

          # Find the city data directory
          city_dir="../output/${{ matrix.city }}/${{ matrix.city }}"

          if [ ! -d "$city_dir" ]; then
            # Try without nested directory
            city_dir="../output/${{ matrix.city }}"
          fi

          echo "Using city directory: $city_dir"

          npx tsx scripts/aggregate-city-data.ts "$city_dir" "public/data/${{ matrix.city }}.json"

          if [ -f "public/data/${{ matrix.city }}.json" ]; then
            size=$(ls -lh "public/data/${{ matrix.city }}.json" | awk '{print $5}')
            echo "âœ… Created ${{ matrix.city }}.json ($size)"
          else
            echo "âŒ Failed to create ${{ matrix.city }}.json"
            exit 1
          fi

      - name: Upload to S3
        working-directory: portal
        run: |
          echo "â˜ï¸ Uploading ${{ matrix.city }}.json to S3..."

          # Gzip and upload
          gzip -c "public/data/${{ matrix.city }}.json" > "public/data/${{ matrix.city }}.json.gz"

          aws s3 cp "public/data/${{ matrix.city }}.json.gz" \
            "s3://jheem-data-production/portal/ryan-white/${{ matrix.city }}.json" \
            --content-type "application/json" \
            --content-encoding "gzip"

          echo "âœ… Uploaded to S3"

  # ===========================================
  # Phase 3: Generate city summaries
  # ===========================================
  finalize:
    needs: [prepare, generate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout jheem-portal
        uses: actions/checkout@v4
        with:
          repository: ncsizemore/jheem-portal
          path: portal

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: portal
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download aggregated city files from S3
        working-directory: portal
        run: |
          echo "ğŸ“¥ Downloading aggregated city files from S3..."
          mkdir -p public/data

          # Download all city JSON files
          aws s3 sync s3://jheem-data-production/portal/ryan-white/ public/data/ \
            --exclude "*" \
            --include "C.*.json"

          echo "Downloaded files:"
          ls -lh public/data/

      - name: Decompress city files
        working-directory: portal
        run: |
          echo "ğŸ“¦ Decompressing gzipped city files..."

          # Files are stored with Content-Encoding: gzip, so they download as gzipped
          # Decompress each file in place
          for f in public/data/C.*.json; do
            if file "$f" | grep -q "gzip compressed"; then
              echo "  Decompressing $f"
              gunzip -c "$f" > "$f.tmp" && mv "$f.tmp" "$f"
            else
              echo "  $f is already plain JSON"
            fi
          done

          echo "Decompressed files:"
          ls -lh public/data/

      - name: Generate city summaries
        working-directory: portal
        run: |
          echo "ğŸ“‹ Generating city summaries..."
          npx tsx scripts/generate-city-summaries.ts

          if [ -f "public/data/city-summaries.json" ]; then
            cities=$(cat public/data/city-summaries.json | grep -o '"C\.[0-9]*"' | wc -l)
            echo "âœ… Generated city-summaries.json with $cities cities"
          else
            echo "âŒ city-summaries.json not created"
            exit 1
          fi

      - name: Upload city summaries to S3
        working-directory: portal
        run: |
          echo "â˜ï¸ Uploading city-summaries.json to S3..."

          gzip -c public/data/city-summaries.json > public/data/city-summaries.json.gz
          aws s3 cp public/data/city-summaries.json.gz \
            "s3://jheem-data-production/portal/ryan-white/city-summaries.json" \
            --content-type "application/json" \
            --content-encoding "gzip"

          echo ""
          echo "=========================================="
          echo "ğŸ“Š GENERATION COMPLETE"
          echo "=========================================="
          echo ""
          echo "ğŸ“‹ S3 contents:"
          aws s3 ls s3://jheem-data-production/portal/ryan-white/
          echo ""
          echo "ğŸŒ Files available at:"
          echo "   https://d320iym4dtm9lj.cloudfront.net/ryan-white/C.XXXXX.json"
