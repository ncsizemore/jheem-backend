# AWS Infrastructure Guide for JHEEM Project - Production Deployment

This is a complete reference guide for AWS setup, management, and troubleshooting for the JHEEM plot generation project. **System is currently in production** serving live data.

## Quick Reference

### Current AWS Setup
- **Account**: 849611540600
- **Region**: us-east-1
- **Budget**: $50/month (matching current Shiny costs)
- **Free Tier Status**: Active (test resources cost $0.00)

### Key Resources (Production)
- **Admin User**: `ncsizemore` (development user)
- **GitHub Actions User**: `jheem-github-actions` (limited permissions)
- **Production Bucket**: `jheem-test-tiny-bucket` (serving live data)
- **Production Table**: `jheem-test-tiny` (contains real plot metadata)
- **API Gateway**: `https://abre4axci6.execute-api.us-east-1.amazonaws.com/prod`
- **Frontend**: `https://jheem-portal.vercel.app/` (live deployment)

## AWS CLI Setup

### Current CLI Configuration
This project uses **AWS CLI v2** (global installation, no virtual environment needed):
```bash
aws --version
# Should show: aws-cli/2.x.x Python/3.x.x Darwin/24.5.0 botocore/2.x.x
```

### Credential Management
```bash
# Check current user
aws sts get-caller-identity

# Admin credentials are stored in:
~/.aws/credentials    # Access keys
~/.aws/config        # Region and output settings
```

### Multi-Environment Usage
- **Production AWS**: Use `aws` commands directly
- **LocalStack Development**: 
  ```bash
  source ~/localstack-env/bin/activate
  awslocal s3 ls
  ```

## User Management

### Admin User (Development Account)
- **Username**: `ncsizemore`
- **Permissions**: AdministratorAccess
- **Use for**: Development, infrastructure management, debugging
- **MFA**: Enabled on root account

### GitHub Actions User (Automation Account)
- **Username**: `jheem-github-actions`
- **Permissions**: Limited to `jheem-*` resources only
- **Use for**: Automated plot generation via GitHub Actions
- **Access Keys**: Stored in GitHub Secrets

### GitHub Actions User Permissions
The limited user can ONLY:
- **S3**: Read/write objects in `jheem-*` buckets
- **DynamoDB**: Read/write items in `jheem-*` tables
- **CloudWatch**: Send metrics to `JHEEM/PlotGeneration` namespace

The limited user CANNOT:
- Access other AWS services (EC2, IAM, etc.)
- Create/delete infrastructure
- Access non-JHEEM resources
- Incur costs outside JHEEM scope

## Cost Management

### Budget Setup
- **Monthly Budget**: $50
- **Email Alerts**: nsizemo1@jh.edu
- **Alert Thresholds**: 
  - $10 (20%) - Early warning
  - $25 (50%) - Investigation needed
  - $40 (80%) - Emergency action required

### Free Tier Coverage
JHEEM usage is well within AWS Free Tier:
- **S3**: 5 GB storage (project uses ~64 MB for 64K plots)
- **S3 Requests**: 20K GET + 2K PUT (will exceed PUT at full scale = ~$0.31)
- **DynamoDB**: 25 GB storage + 200M requests (project uses tiny fraction)
- **Expected Monthly Cost**: $0.31 for full 64K plots

### Cost Monitoring
```bash
# Check current costs (after 24-48 hours)
cd infrastructure
./check-costs.sh

# View in console
# https://console.aws.amazon.com/billing/home#/bills
# https://console.aws.amazon.com/billing/home#/budgets
```

## Infrastructure Scripts

### Setup Scripts Location
```
jheem-backend/infrastructure/
├── aws-cost-monitoring.sh     # Budget and alerts
├── github-actions-iam.sh      # Limited user creation
├── test-infrastructure.sh     # Test resources
└── README.md                  # This file
```

### Running Scripts
```bash
cd infrastructure

# 1. Set up cost monitoring (safe, no billable resources)
bash aws-cost-monitoring.sh

# 2. Create GitHub Actions user (safe, just IAM user)
bash github-actions-iam.sh

# 3. Create test infrastructure (creates tiny billable resources)
bash test-infrastructure.sh
```

## Current Production Infrastructure

### Resources Created
- **S3 Bucket**: `jheem-test-tiny-bucket`
  - Contains real plot files generated by GitHub Actions
  - Structure: `github_actions_integration/[CITY]/[CITY]/[SCENARIO]/`
  - Real plot data serving frontend at https://jheem-portal.vercel.app/
  - Cost: $0.00 (free tier)

- **DynamoDB Table**: `jheem-test-tiny`
  - Contains live plot metadata with composite key schema
  - Schema: `city_scenario` (HASH) + `outcome_stat_facet` (RANGE)
  - Serving production API at https://abre4axci6.execute-api.us-east-1.amazonaws.com/prod
  - Cost: ~$0.33/month (pay-per-request)

- **Lambda Functions**: 4 production functions
  - `jheem-backend-prod-getAllCities`
  - `jheem-backend-prod-searchPlots`
  - `jheem-backend-prod-getPrerunPlot`
  - `jheem-backend-prod-registerPlot`
  - Cost: $0.00 (free tier)

- **API Gateway**: Production REST API
  - Endpoints: `/plots/cities`, `/plots/search`, `/plot`, `/plots/register`
  - CORS configured for Vercel frontend
  - Cost: $0.00 (free tier)

### Production Testing Commands
```bash
# Test S3 access (real production data)
aws s3 ls s3://jheem-test-tiny-bucket/github_actions_integration/ --recursive

# Test DynamoDB access (live metadata)
aws dynamodb scan --table-name jheem-test-tiny --max-items 3

# Test production API endpoints
curl "https://abre4axci6.execute-api.us-east-1.amazonaws.com/prod/plots/cities"
curl "https://abre4axci6.execute-api.us-east-1.amazonaws.com/prod/plots/search?city=C.12580&scenario=cessation"

# Test GitHub Actions user access
export AWS_ACCESS_KEY_ID=github-actions-access-key
export AWS_SECRET_ACCESS_KEY=github-actions-secret-key
aws s3 ls s3://jheem-test-tiny-bucket/    # Should work
aws iam list-users                        # Should fail (good!)
unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY

# Test Lambda functions directly
aws lambda invoke --function-name jheem-backend-prod-getAllCities --payload '{}' response.json
```

## GitHub Integration

### GitHub Secrets Required
In GitHub repository settings → Secrets and variables → Actions:
- `AWS_ACCESS_KEY_ID`: From `jheem-github-actions` user
- `AWS_SECRET_ACCESS_KEY`: From `jheem-github-actions` user
- `AWS_REGION`: `us-east-1`

### Workflow Integration
The GitHub Actions workflow uses these secrets to:
1. Upload generated plot JSON files to S3
2. Register plot metadata in DynamoDB
3. Send performance metrics to CloudWatch

## Security Best Practices

### Implementation Status
- ✅ Root account secured with MFA
- ✅ Working through IAM user (not root)
- ✅ Created limited user for automation
- ✅ Least-privilege permissions
- ✅ Cost monitoring and budgets
- ✅ Free tier usage validation

### Access Key Management
- **Never commit access keys to git**
- **Rotate keys periodically** (every 90 days recommended)
- **Use GitHub Secrets** for automation credentials
- **Monitor usage** in AWS CloudTrail if needed

## Troubleshooting

### Common Issues

#### "Access Denied" Errors
```bash
# Check which user is active
aws sts get-caller-identity

# If wrong user, check credentials
cat ~/.aws/credentials
aws configure list
```

#### Cost Alerts Not Working
- Check email: nsizemo1@jh.edu
- Billing data takes 24-48 hours to appear
- Verify budget exists in AWS Console

#### GitHub Actions Failures
1. **Check GitHub Secrets** are set correctly
2. **Verify IAM user permissions** in AWS Console
3. **Test access keys manually** with AWS CLI
4. **Check AWS resource exists** (bucket, table names)

### Useful Console Links
- **Billing Dashboard**: https://console.aws.amazon.com/billing/home#/bills
- **Cost Explorer**: https://console.aws.amazon.com/ce/home
- **IAM Users**: https://console.aws.amazon.com/iam/home#/users
- **S3 Buckets**: https://console.aws.amazon.com/s3/
- **DynamoDB Tables**: https://console.aws.amazon.com/dynamodb/

## Production Deployment Status

### ✅ Current Status: Production Ready
- ✅ **Live System**: https://jheem-portal.vercel.app/ serving real data
- ✅ **API Integration**: Production Lambda functions operational
- ✅ **Plot Generation**: GitHub Actions container pipeline working
- ✅ **Cost Optimization**: ~$1-2/month (95% reduction from $50/month Shiny)
- ✅ **Performance**: Sub-2-second plot loading

### Completed Production Milestones
- ✅ **AWS Infrastructure**: S3, DynamoDB, Lambda, API Gateway deployed
- ✅ **Serverless Backend**: All 4 API endpoints functional
- ✅ **Frontend Integration**: Vercel deployment connected to AWS API
- ✅ **GitHub Actions**: Container-based plot generation operational
- ✅ **End-to-End Testing**: Full user flow validated

### Next: Scale Production Data
- **Current**: 1 city (C.12580) with cessation scenario
- **Next**: Test configuration (4 cities, ~300 plots)
- **Target**: Full scale (31 cities, ~64K plots)
- **Timeline**: Ready for scale-up on demand

## Quick Commands Reference

```bash
# Check AWS setup
aws sts get-caller-identity
aws s3 ls
aws dynamodb list-tables

# Switch to LocalStack
source ~/localstack-env/bin/activate
awslocal s3 ls

# Check costs (after 24-48 hours)
cd infrastructure && ./check-costs.sh

# Test limited user permissions
export AWS_ACCESS_KEY_ID=github-actions-key
aws s3 ls s3://jheem-test-tiny-bucket/  # Should work
aws iam list-users                      # Should fail
unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY
```

## Support Contacts

- **AWS Support**: Account has basic support
- **Billing Questions**: AWS Billing Dashboard or support tickets
- **JHEEM Project**: This documentation and session history
- **Emergency**: Delete resources manually via AWS Console if costs spike
